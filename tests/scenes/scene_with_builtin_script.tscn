[gd_scene load_steps=3 format=3 uid="uid://dbu7cb0h10jdt"]

[ext_resource type="PackedScene" uid="uid://dbh6jrpcqwj76" path="res://addons/godot_tooltip_component_by_greenpixels/lib/core/tooltip/tooltip.tscn" id="1_2rq01"]

[sub_resource type="GDScript" id="GDScript_euhnp"]
resource_name = "TooltipOcerlay"
script/source = "extends CanvasLayer

@onready var layout_wrapper : Node = %LayoutWrapper
@onready var tooltip_container : Node = %TooltipContainer
@onready var main_tooltip : Node = %MainTooltip
@onready var tooltip_loading_bar : ProgressBar = %TooltipLoadingBar
@onready var tooltip_scene : PackedScene = preload(\"res://addons/godot_tooltip_component_by_greenpixels/lib/core/tooltip/tooltip.tscn\")
@export var highlighted_keys : Array[TooltipHighlightedKey]
@export var explanations_delay : float = 1.25
@export var tooltip_transition_type : Tween.TransitionType = Tween.TRANS_ELASTIC
@export var tooltip_easing_type : Tween.EaseType = Tween.EASE_OUT
var current_tooltip_element: Control = null
var explanations : Array[Node] = []

func _ready() -> void:
	layout_wrapper.scale = Vector2(0, 1)


func conceal() -> void:
	# tooltip_container.reset_size()
	current_tooltip_element = null
	TweenHelper.tween(\"tooltip_container_scale\", layout_wrapper).tween_property(layout_wrapper, \"scale\", Vector2(0, 1), 0.05).set_trans(Tween.TRANS_SINE).set_ease(Tween.EASE_OUT)

func describe(origin_node: Control, content: String, show_extra_explanation: bool = false) -> void:
	if OS.get_name() == \"Android\":
		await ControllerContext.on_hold_press_pressed
	
	if LimboManager.should_hide_tooltips: return
	if current_tooltip_element != null:
		current_tooltip_element.mouse_exited.disconnect(conceal)
	current_tooltip_element = origin_node
	if not current_tooltip_element.mouse_exited.is_connected(conceal):
		current_tooltip_element.mouse_exited.connect(conceal)
	var origin_x_position : float = 0
	if origin_node:
		origin_x_position = origin_node.global_position.x
	var viewport_center_position : float =  get_viewport().get_visible_rect().size.x / 2
	tooltip_loading_bar.value = 0
	TweenHelper.tween(\"load_progress\", tooltip_loading_bar).tween_property(tooltip_loading_bar, \"value\", 0, 0)
	__cleanup()
	main_tooltip.set_description(apply_bbcode_for_common_keys(content, show_extra_explanation))
	if not explanations.is_empty():
		TweenHelper.tween(\"load_progress\", tooltip_loading_bar).tween_property(tooltip_loading_bar, \"value\", 100, explanations_delay)
	
	for explanation in explanations:
		var current_modulate : Color = explanation.modulate
		explanation.modulate.a = 0
		TweenHelper.tween(\"fade_in\", explanation).tween_property(explanation, \"modulate\", current_modulate, 0.15).set_delay(explanations_delay)
	
	 
	if origin_x_position > viewport_center_position:
		layout_wrapper.set_anchors_and_offsets_preset(Control.PRESET_BOTTOM_LEFT, Control.PRESET_MODE_KEEP_WIDTH)
	else:
		layout_wrapper.set_anchors_and_offsets_preset(Control.PRESET_BOTTOM_RIGHT, Control.PRESET_MODE_KEEP_WIDTH)
	tooltip_container.scale = Vector2(1, 1)
	layout_wrapper.scale = Vector2(0,1)
	TweenHelper.tween(\"tooltip_container_scale\", layout_wrapper).tween_property(layout_wrapper, \"scale\", Vector2(1, 1), 0.25).set_trans(tooltip_transition_type).set_ease(tooltip_easing_type)
	if OS.get_name() == \"Android\":
		await ControllerContext.on_hold_press_released
		conceal()
	
func apply_bbcode_for_common_keys(content: String, show_explanations: bool) -> String:
	if show_explanations:
		for highlighted_key in highlighted_keys:
			if highlighted_key.explanation:
				content = add_explanation(content, \"{\" + highlighted_key.key + \"}\", highlighted_key.explanation.explanation_tr_key, highlighted_key.explanation.should_remove_key, \"\", highlighted_key.explanation.is_purchasable)
		
	for highlighted_key in highlighted_keys:
		var replacement_bbcode_builder : BBCodeHelper = BBCodeHelper.build(tr(highlighted_key.tr_key).capitalize())
		if highlighted_key.icon:
			replacement_bbcode_builder = replacement_bbcode_builder.add_icon(highlighted_key.icon)
		replacement_bbcode_builder.color(\"#\" + highlighted_key.color.to_html(true))
		content = content.format({highlighted_key.key: replacement_bbcode_builder.result()})
	content.strip_edges()

	return content

func add_explanation(current_content: String, key_to_replace: StringName, explanation: String, should_remove_key : bool = false, title: String = \"\", is_purchasable: bool = false) -> String:
	if not current_content.contains(key_to_replace): return current_content
	if title.is_empty(): title = key_to_replace
	var popover : Control = tooltip_scene.instantiate()
	tooltip_container.add_child(popover)
	var description_output : String = tr(explanation) 
	if is_purchasable:
		if UpperSidebar.all_purchasables_by_key.has(explanation + \"_NAME\"):
			description_output = ShopItem.get_description_by_purchasable(UpperSidebar.all_purchasables_by_key[explanation + \"_NAME\"])
		else:
			push_error(\"Unable to find purchasable by key of \", explanation + \"_NAME\")
	popover.set_description(
		apply_bbcode_for_common_keys(title, false) +
		\"\\n\\n\" +
		apply_bbcode_for_common_keys(description_output, false)
	)
	
	explanations.push_back(popover)
	
	tooltip_container.move_child(popover, 0)
	if should_remove_key: current_content = current_content.replace(key_to_replace, \"\")
	return current_content

func __cleanup() -> void:
	for node in explanations:
		node.queue_free()
	explanations = []
"

[node name="TooltipOverlay" type="CanvasLayer"]
layer = 5
script = SubResource("GDScript_euhnp")

[node name="LayoutWrapper" type="MarginContainer" parent="."]
unique_name_in_owner = true
anchors_preset = 3
anchor_left = 1.0
anchor_top = 1.0
anchor_right = 1.0
anchor_bottom = 1.0
offset_left = -401.0
offset_top = -101.0
grow_horizontal = 0
grow_vertical = 0
mouse_filter = 2
metadata/_edit_group_ = true

[node name="TooltipContainer" type="VBoxContainer" parent="LayoutWrapper"]
unique_name_in_owner = true
layout_mode = 2
size_flags_vertical = 8
mouse_filter = 2

[node name="MainTooltip" parent="LayoutWrapper/TooltipContainer" instance=ExtResource("1_2rq01")]
unique_name_in_owner = true
layout_mode = 2

[node name="TooltipLoadingBar" type="ProgressBar" parent="LayoutWrapper/TooltipContainer/MainTooltip"]
unique_name_in_owner = true
visible = false
layout_mode = 2
show_percentage = false
